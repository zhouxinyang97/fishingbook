# Fishing Book v2.0 PRD - Feature Spec（功能规格）

## 1. 术语与定义
- 书库（Library）：用户选择的一个本地文件夹路径，用于承载“书本清单”配置与（可选）内容文件。
- 书本（Book）：一个可阅读的本地文件（v2.0 以 `.txt/.log/.md` 为主，保持与当前读取能力一致）。
- 阅读进度（Progress）：按书本维度保存的“上次阅读位置”，v2.0 以 `scrollRatio (0~1)` 作为最小可行表示。

## 2. 功能清单（按 Must/Should/Could）

### 2.1 Must（v2.0 必须交付）
- 书库选择并打开：支持选择一个文件夹作为书库；保存“最近书库”；支持启动时自动打开上次书库。
- 书本导入：从文件选择器导入 1 个或多个文件到书架（默认“引用原路径”）。
- 书本列表管理：列表展示、搜索、移除、重命名显示名（不改文件名）。
- 书本打开：从书架打开进入阅读器。
- 按书保存/恢复阅读进度：打开书本时恢复；阅读滚动时保存；不同书互不覆盖。
- 迁移：从当前 `session.json` 的 `lastFilePath/lastScrollRatio` 尽可能迁移到对应书本的进度（如果该文件被导入过）。
- 阅读器全局外观设置：透明度与主题色作为全局设置保存并生效。
- 阅读器窗口拖拽缩放：支持像 v1.0 一样拖拽窗口边缘/角调整大小。

### 2.2 Should（资源允许则做）
- 最近阅读/继续阅读：书架顶部展示“最后阅读书本”卡片，支持一键续读。
- 丢失文件处理：文件不存在时的明显标识与“重新定位文件”修复流程。
- 去重策略：同一书库内避免重复导入同一路径文件；提示“已存在”。

### 2.3 Could（不影响 v2.0 核心时再做）
- 复制导入：可选“复制到书库目录”以实现自包含（大文件与版权风险需评估）。
- 简单分组：按文件夹/标签分组（非 v2.0）。

## 3. 页面与流程（关键路径）

### 3.1 首次使用（Onboarding）
1) 启动 → 进入“书库选择页”
2) 用户点击“打开其他书库…”选择文件夹
3) 写入/更新 `libraries.json`，设置 `activeLibraryId`
4) 进入书架页（空态）→ 点击“导入书本”
5) 导入成功 → 列表展示 → 点击“打开”进入阅读器

### 3.2 日常续读（Habit Loop）
1) 启动（若开启“自动打开上次书库”）→ 直接进入书架
2) 点击“继续阅读”或列表书本 → 进入阅读器并恢复进度
3) 滚动阅读 → 定期保存 `progress`

### 3.3 多书切换
- 在阅读器点击“← 书架”返回书架后，打开另一书；两本书的进度都能分别续读。

## 4. 数据模型（本地持久化）

> 设计原则：可读、可迁移、低耦合、崩溃可恢复。v2.0 不引入数据库，先用 JSON 文件（与现有 `session.json` 风格一致）。

### 4.1 存储位置
- 根路径：Electron `app.getPath('userData')`（与当前 `session.json` 同目录）
- 新增文件（建议）：
  - `libraries.v2.0.json`：书库清单与当前书库
  - `books.<libraryId>.v2.0.json`：指定书库下的书本清单
  - `progress.<libraryId>.v2.0.json`：指定书库下的阅读进度
  - `settings.v2.0.json`：全局设置（透明度、主题色、窗口尺寸与位置）

> 注：文件名包含 `v2.0` 便于未来版本迁移与并行兼容。

### 4.3 Book（书本）
```json
{
  "schemaVersion": "2.0",
  "libraryId": "lib_9b8c",
  "books": [
    {
      "id": "book_3f1a",
      "displayTitle": "射雕英雄传",
      "filePath": "D:\\\\Books\\\\Novels\\\\射雕英雄传.txt",
      "addedAt": 1761000000000,
      "lastOpenedAt": 1765000000000,
      "fileStat": { "size": 1234567, "mtimeMs": 1764000000000 }
    }
  ]
}
```

**BookId 生成建议（v2.0）**
- 默认：`bookId = stableHash(filePath)`（简单、性能好）
- 风险：文件移动导致 bookId 变化；需通过“重新定位文件”修复时保持原 id（见 5.2）。

### 4.4 Progress（阅读进度）
```json
{
  "schemaVersion": "2.0",
  "libraryId": "lib_9b8c",
  "progressByBookId": {
    "book_3f1a": { "scrollRatio": 0.42, "updatedAt": 1765001234567 }
  },
  "lastReadBookId": "book_3f1a"
}
```

**保存策略**
- 触发：阅读器滚动时，采用节流/合并（例如 `requestAnimationFrame` + 间隔阈值）写入。
- 数据：仅保存 `scrollRatio`（最小可用）；若文本渲染策略变化导致 ratio 不稳定，后续可扩展保存 `anchor`（如行号/字符 offset），但 v2.0 不强制。

## 5. 边界与异常处理（必须覆盖）

### 5.1 书库级
- 书库路径不存在：最近列表标红；点击打开时提示“路径失效”，可“移除/重新选择文件夹”。
- 书库不可写：仍允许“引用导入”，但 `books/progress` JSON 写入失败需提示并进入只读模式（不承诺保存进度）。
- 同名书库：允许（按 id 区分）；UI 需展示 path 辅助识别。

### 5.2 书本级
- 文件不存在/被移动：书架标记“文件缺失”；打开时提供：
  - 重新定位：用户选择新路径后更新 `filePath`（保留原 `bookId`）
  - 从书库移除：同时清理该 `bookId` 的进度
- 重复导入：
  - 同书库内 `filePath` 完全相同：拒绝并提示“已在书库中”
  - 不同书库允许重复（进度隔离在各自 `progress.<libraryId>` 中）
- 大文件性能：渲染可能卡顿；v2.0 要求“导入/打开/恢复进度”不因保存逻辑造成额外明显卡顿（见 NFR）。
- 内容变化（追更）：文件变大/变小后，按 `scrollRatio` 恢复可能偏移；属可接受范围，但需在错误/偏移过大时提供“回到顶部”快捷入口（v2.0 可选）。

### 5.4 全局设置与窗口
- 设置写入失败：若 `settings.v2.0.json` 写入失败，应退化为本次运行内生效，并提示“设置未保存（只读/无权限）”。
- 主题/透明度异常值：读取到非法值时回退默认主题与默认透明度。
- 窗口最小尺寸：缩放时强制最小宽高（建议：宽 ≥ 360px，高 ≥ 240px），避免 UI 不可用。
- 缩放性能：窗口缩放过程中不应触发大文本重新渲染/重新解码；缩放结束后再恢复渲染（与 v1.0 策略一致）。

### 5.3 迁移（从现有 session）
- 当前版本存在 `session.json` 字段：`lastFilePath`, `lastScrollRatio`（见 main.js）。
- v2.0 迁移规则：
  - 若用户导入书本后其 `filePath == session.lastFilePath`，则写入对应 `bookId` 的 `scrollRatio=session.lastScrollRatio`。
  - 若未导入，则不自动创建 book（避免“编造书本”）；仅在 UI 上可提示“你上次读的是某文件，可导入后续读”。

## 6. 权限与安全
- 全部数据本地存储于 `userData`；不上传网络。
- 书库路径/书本路径属于用户敏感信息：日志中避免输出完整路径（除 debug 模式）。

## 7. 非功能需求（NFR）
- 启动：进入“书库选择/书架”的可交互时间 ≤ 1s（在普通 SSD 机器上）。
- 保存进度：滚动时保存不造成明显掉帧；写入频率建议 ≤ 1 次/2 秒（可配置）。
- 可靠性：写入 JSON 需原子性（写临时文件再 rename）以避免崩溃损坏（v2.0 必须）。
- 兼容：Windows 10/11 优先；路径分隔符与编码处理需兼容中文路径。
- 可用性：透明度与主题切换应即时生效，且不引入明显卡顿。
- 性能：窗口缩放过程中保持流畅；缩放完成后恢复渲染的时间应可接受（与文本大小相关）。
