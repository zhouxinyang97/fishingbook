# Fishing Book v2.0 PRD - IPC API & Event Tracking（接口与埋点）

## 1. IPC API（主进程 ↔ 渲染进程）

> 说明：当前工程通过 `preload.js` 暴露 `window.electronAPI`，并使用 `ipcMain.handle/on`。v2.0 书库功能建议延续该模式。

### 1.1 Libraries
- `library:list`（handle）
  - req：`{}`
  - resp：`{ success, data?: { activeLibraryId, libraries[] }, error? }`
- `library:chooseFolderAndAdd`（handle）
  - 行为：弹出选择文件夹对话框；创建/加入最近书库；设为 active
  - resp：`{ success, library?, canceled?, error? }`
- `library:setActive`（handle）
  - req：`{ libraryId }`
  - resp：`{ success }`
- `library:remove`（handle）
  - req：`{ libraryId }`
  - resp：`{ success }`

### 1.2 Books
- `book:list`（handle）
  - req：`{ libraryId }`
  - resp：`{ success, books[] }`
- `book:importFiles`（handle）
  - 行为：弹出选择文件对话框（支持多选）；将文件加入书本清单（引用路径）
  - req：`{ libraryId }`
  - resp：`{ success, importedCount, skippedCount, errors?[] }`
- `book:rename`（handle）
  - req：`{ libraryId, bookId, displayTitle }`
  - resp：`{ success }`
- `book:remove`（handle）
  - req：`{ libraryId, bookId }`
  - resp：`{ success }`
- `book:relinkFile`（handle）
  - req：`{ libraryId, bookId }`（主进程弹出文件选择器）
  - resp：`{ success, filePath?, canceled?, error? }`

### 1.3 Reader / Progress
- `reader:openBook`（handle）
  - 行为：读取文件并解码（复用现有 `decodeText`），并返回该 book 的 progress
  - req：`{ libraryId, bookId }`
  - resp：`{ success, fileName, filePath, content, encoding, progress?: { scrollRatio } }`
- `progress:get`（handle）
  - req：`{ libraryId, bookId }`
  - resp：`{ success, progress?: { scrollRatio, updatedAt } }`
- `progress:save`（send 或 handle）
  - req：`{ libraryId, bookId, scrollRatio }`
  - 说明：建议与当前 `save-session` 类似用 send；但为保证写入结果可观测，v2.0 可改为 handle。

## 2. 数据读写事件（内部）
- `LIBRARY_OPENED`：进入书架后触发，用于更新 `lastOpenedAt`
- `BOOK_IMPORTED`：导入成功触发，用于写入 `addedAt`
- `BOOK_OPENED`：进入阅读器触发，用于写入 `lastOpenedAt` 与 `lastReadBookId`
- `PROGRESS_SAVED`：写入进度触发（带节流），用于 debug 与可靠性观察

## 3. 埋点（可选，不影响离线使用）

> v2.0 不要求接入第三方统计；此处定义“事件字典”，便于未来接入时保持一致。若不接入，仍可写本地 debug log。

### 3.1 事件字典
- `app_launch`
  - props：`{ hasRecentLibrary: boolean, autoOpenEnabled: boolean }`
- `library_open`
  - props：`{ libraryId, source: "auto"|"picker_recent"|"picker_choose"|"switcher" }`
- `book_import`
  - props：`{ libraryId, importedCount, skippedCount }`
- `book_open`
  - props：`{ libraryId, bookId, source: "bookshelf"|"continue" }`
- `progress_save`
  - props：`{ libraryId, bookId, scrollRatioBucket: "0-10"|"10-30"|"30-60"|"60-90"|"90-100" }`
- `book_missing_relink`
  - props：`{ libraryId, bookId, result: "success"|"canceled"|"failed" }`

### 3.2 隐私原则
- 不上报完整 `filePath` 与 `libraryPath`；仅上报 hash 或脱敏信息（如路径层级深度、是否包含中文字符等）。
