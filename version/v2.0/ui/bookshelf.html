<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark" />
    <title>Fishing Book v2.0 Â· ä¹¦æ¶</title>
    <link rel="stylesheet" href="./fb-ui.css" />
  </head>
  <body>
    <div class="app">
      <div class="window sim-window" role="application" aria-label="Fishing Book v2.0 åŸå‹ Â· ä¹¦æ¶ï¼ˆå¯æ‹–æ‹½ç¼©æ”¾ï¼‰">
        <div class="window-bar">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div class="title">Fishing Book</div>
            <div class="subtitle" id="barSubtitle">v2.0 Â· ä¹¦æ¶</div>
          </div>
          <div class="bar-actions" aria-label="ä¹¦æ¶å·¥å…·æ ">
            <span class="pill" title="åŸå‹æ¨¡æ‹Ÿï¼šæ‹–æ‹½æ ‡é¢˜æ ç©ºç™½åŒºåŸŸç§»åŠ¨ï¼›æ‹–æ‹½å³ä¸‹è§’ç¼©æ”¾">å¯æ‹–æ‹½/ç¼©æ”¾</span>
            <button class="btn" type="button" id="btnLibSwitcher" aria-haspopup="dialog">
              <span aria-hidden="true">ğŸ—‚</span>
              <span id="activeLibName">å½“å‰ä¹¦åº“</span>
              <span class="faint" aria-hidden="true">â–¼</span>
            </button>
            <button class="btn btn-primary" type="button" id="btnImport">
              <span aria-hidden="true">ï¼‹</span> å¯¼å…¥ä¹¦æœ¬
            </button>
            <button class="btn btn-ghost" type="button" id="btnSettings" aria-haspopup="dialog">è®¾ç½®</button>
          </div>
        </div>

        <div class="debug" data-debug-panel>
          <label for="stateSel2">çŠ¶æ€</label>
          <select id="stateSel2" data-debug-state aria-label="åˆ‡æ¢é¡µé¢çŠ¶æ€">
            <option value="default">default</option>
            <option value="loading">loading</option>
            <option value="empty">empty</option>
            <option value="error">error</option>
          </select>
          <span class="pill">debug</span>
        </div>

        <div class="content">
          <!-- Error banner (only in error state) -->
          <div class="state" data-state="error" style="margin-bottom:12px;">
            <div class="banner" role="alert">
              <div class="msg">
                ä¹¦åº“å¤„äºåªè¯»æ¨¡å¼ï¼šæ— æ³•å†™å…¥ä¹¦æœ¬æ¸…å• / é˜…è¯»è¿›åº¦
                <div class="sub">åŸå› ç¤ºä¾‹ï¼šè·¯å¾„ä¸å¯å†™ï¼ˆæ— æƒé™ï¼‰ / JSON å†™å…¥å¤±è´¥</div>
              </div>
              <a class="btn btn-ghost" href="./library-picker.html?state=default" title="è¿”å›ä¹¦åº“é€‰æ‹©">åˆ‡æ¢ä¹¦åº“</a>
            </div>
          </div>

          <div class="grid">
            <section class="card">
              <div class="card-hd">
                <div style="flex:1; min-width:0;">
                  <div class="card-title">æœç´¢</div>
                  <div class="card-desc">æŒ‰æ ‡é¢˜æˆ–è·¯å¾„å…³é”®è¯è¿‡æ»¤ã€‚å°çª—å£å®½åº¦ &lt; 360px ä¼šéšè—æ›´æ–°æ—¶é—´åˆ—ã€‚</div>
                </div>
                <div class="pill" title="é”®ç›˜æç¤ºï¼šåœ¨æœç´¢æ¡†æŒ‰ Enter ä¸ä¼šæäº¤è¡¨å•ï¼Œä»…ä¿ç•™ç„¦ç‚¹">
                  <span class="muted">å¿«æ·é”®</span> <span class="kbd">Tab</span>
                </div>
              </div>
              <div class="card-bd">
                <div class="input" role="search">
                  <span aria-hidden="true">âŒ•</span>
                  <input id="search" type="text" placeholder="å…³é”®å­—â€¦" autocomplete="off" />
                </div>
              </div>
            </section>

            <aside class="card">
              <div class="card-hd">
                <div>
                  <div class="card-title">ç»§ç»­é˜…è¯»</div>
                  <div class="card-desc">å¯¹é½ PRD â€œæœ€è¿‘é˜…è¯»/ç»§ç»­é˜…è¯»â€å¡ç‰‡ï¼›æŒ‰ä¹¦æ¢å¤è¿›åº¦ï¼ˆscrollRatioï¼‰ã€‚</div>
                </div>
              </div>
              <div class="card-bd">
                <div class="state" data-state="loading" aria-hidden="true">
                  <div class="skeleton big"></div>
                </div>
                <div class="state" data-state="default" id="continueCardWrap"></div>
                <div class="state" data-state="empty">
                  <div class="empty" style="padding:14px 12px;">
                    <h2>æš‚æ— å¯ç»­è¯»ä¹¦æœ¬</h2>
                    <p>å¯¼å…¥å¹¶æ‰“å¼€ä¹¦æœ¬åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæœ€åé˜…è¯»çš„ä¸€æœ¬ã€‚</p>
                  </div>
                </div>
                <div class="state" data-state="error">
                  <div class="empty" style="padding:14px 12px;">
                    <h2>åªè¯»æ¨¡å¼</h2>
                    <p>ä»å¯æ‰“å¼€å·²å¯¼å…¥ä¹¦æœ¬ï¼Œä½†è¿›åº¦å¯èƒ½æ— æ³•ä¿å­˜ã€‚</p>
                  </div>
                </div>
              </div>
            </aside>
          </div>

          <div style="height:14px;"></div>

          <section class="card">
            <div class="card-hd">
              <div>
                <div class="card-title">ä¹¦æœ¬åˆ—è¡¨</div>
                <div class="card-desc">æ”¯æŒï¼šæ‰“å¼€ã€é‡å‘½åæ˜¾ç¤ºåã€ç§»é™¤ã€æ–‡ä»¶ç¼ºå¤±ä¿®å¤ï¼ˆé‡æ–°å®šä½/ç§»é™¤ï¼‰ã€‚</div>
              </div>
              <div class="pill">
                <span class="muted">æ¼”ç¤º</span>
                <a href="./library-picker.html" title="è¿”å›ä¹¦åº“é€‰æ‹©">ä¹¦åº“é€‰æ‹©</a>
              </div>
            </div>
            <div class="card-bd">
              <!-- Default -->
              <div class="state" data-state="default">
                <div class="table" role="table" aria-label="ä¹¦æœ¬è¡¨æ ¼">
                  <div class="t-head" role="row">
                    <div class="t-cell" role="columnheader">ä¹¦å</div>
                    <div class="t-cell hide-xs" role="columnheader">æ›´æ–°æ—¶é—´</div>
                    <div class="t-cell" role="columnheader">çŠ¶æ€</div>
                    <div class="t-cell" role="columnheader" style="text-align:right;">æ“ä½œ</div>
                  </div>
                  <div id="bookRows"></div>
                </div>
                <div class="sep"></div>
                <div class="muted" style="font-size:12.5px; line-height:1.65;">
                  æç¤ºï¼šè‹¥ä¹¦æœ¬æ–‡ä»¶è¢«ç§»åŠ¨/åˆ é™¤ï¼Œåˆ—è¡¨ä¼šæ ‡è®°â€œæ–‡ä»¶ç¼ºå¤±â€ã€‚ç‚¹å‡»â€œæ‰“å¼€â€å°†è¿›å…¥ä¿®å¤æµç¨‹ï¼šé‡æ–°å®šä½æ–‡ä»¶ / ä»ä¹¦åº“ç§»é™¤ã€‚
                </div>
              </div>

              <!-- Empty -->
              <div class="state" data-state="empty">
                <div class="empty">
                  <div class="illus" aria-hidden="true"></div>
                  <h2>ä¹¦æ¶é‡Œè¿˜æ²¡æœ‰ä¹¦æœ¬</h2>
                  <p>æ”¯æŒå¯¼å…¥ <span class="kbd">.txt</span> / <span class="kbd">.log</span> / <span class="kbd">.md</span>ï¼ˆä¿æŒä¸ç°æœ‰è¯»å–èƒ½åŠ›ä¸€è‡´ï¼‰ã€‚</p>
                  <div class="cta">
                    <button class="btn btn-primary" type="button" data-open-import>
                      <span aria-hidden="true">ï¼‹</span> å¯¼å…¥ä¹¦æœ¬
                    </button>
                    <a class="btn" href="./reader.html?state=loading" title="è·³è½¬åˆ°é˜…è¯»å™¨åŠ è½½æ€ï¼ˆæ¼”ç¤ºç”¨ï¼‰">æŸ¥çœ‹é˜…è¯»å™¨åŠ è½½æ€</a>
                  </div>
                </div>
              </div>

              <!-- Loading -->
              <div class="state" data-state="loading" aria-busy="true">
                <div class="table" aria-hidden="true">
                  <div class="t-head"><div>ä¹¦å</div><div class="hide-xs">æ›´æ–°æ—¶é—´</div><div>çŠ¶æ€</div><div style="text-align:right;">æ“ä½œ</div></div>
                  <div class="t-row"><div class="skeleton" style="width:70%"></div><div class="skeleton hide-xs" style="width:56%"></div><div class="skeleton" style="width:50%"></div><div class="skeleton" style="width:110px; justify-self:end;"></div></div>
                  <div class="t-row"><div class="skeleton" style="width:76%"></div><div class="skeleton hide-xs" style="width:64%"></div><div class="skeleton" style="width:42%"></div><div class="skeleton" style="width:110px; justify-self:end;"></div></div>
                  <div class="t-row"><div class="skeleton" style="width:62%"></div><div class="skeleton hide-xs" style="width:52%"></div><div class="skeleton" style="width:48%"></div><div class="skeleton" style="width:110px; justify-self:end;"></div></div>
                </div>
              </div>

              <!-- Error -->
              <div class="state" data-state="error">
                <div class="empty">
                  <div class="illus" aria-hidden="true"></div>
                  <h2>æ— æ³•åŠ è½½ä¹¦æœ¬æ¸…å•</h2>
                  <p>è¯·å°è¯•åˆ‡æ¢åˆ°å…¶ä»–ä¹¦åº“ï¼Œæˆ–æ£€æŸ¥å½“å‰ä¹¦åº“è·¯å¾„æ˜¯å¦å¯å†™ã€‚</p>
                  <div class="cta">
                    <a class="btn btn-primary" href="./library-picker.html" title="è¿”å›ä¹¦åº“é€‰æ‹©">è¿”å›ä¹¦åº“é€‰æ‹©</a>
                    <button class="btn" type="button" id="btnResetBooks">æ¢å¤æ¼”ç¤ºæ•°æ®</button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Resize overlay (prototype) -->
        <div class="resize-overlay" aria-hidden="true">
          <div class="resize-overlay-card">
            ç¼©æ”¾ä¸­ï¼Œæ¾å¼€åæ¢å¤æ¸²æŸ“
            <span class="resize-overlay-meta" data-resize-meta></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-wrap" data-toast-wrap aria-live="polite" aria-relevant="additions"></div>

    <!-- Modal: library switcher -->
    <div class="modal-backdrop" id="mLibs" role="dialog" aria-modal="true" aria-label="åˆ‡æ¢ä¹¦åº“">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">åˆ‡æ¢ä¹¦åº“</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mLibs" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <div class="list" id="libListModal" aria-label="ä¹¦åº“åˆ—è¡¨"></div>
          <div class="sep"></div>
          <a class="btn btn-primary" href="./library-picker.html" title="å›åˆ°ä¹¦åº“é€‰æ‹©é¡µ">æ‰“å¼€å…¶ä»–ä¹¦åº“â€¦</a>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mLibs">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- Modal: import books -->
    <div class="modal-backdrop" id="mImport" role="dialog" aria-modal="true" aria-label="å¯¼å…¥ä¹¦æœ¬">
      <div class="modal">
        <div class="modal-hd">
          <div>
            <div class="modal-title">å¯¼å…¥ä¹¦æœ¬</div>
            <div class="card-desc" style="margin-top:6px;">ï¼ˆåŸå‹æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©å™¨ï¼šé»˜è®¤â€œå¼•ç”¨åŸè·¯å¾„â€ï¼‰</div>
          </div>
          <button class="btn btn-ghost" type="button" data-modal-close="mImport" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <div class="list" aria-label="å¯å¯¼å…¥æ–‡ä»¶">
            <div class="item">
              <div class="item-main">
                <div class="item-title">é“¶æ²³ç³»æ¼«æ¸¸æŒ‡å—.md</div>
                <div class="item-sub">D:\Books\Misc\é“¶æ²³ç³»æ¼«æ¸¸æŒ‡å—.md</div>
              </div>
              <div class="item-actions">
                <label class="pill" style="cursor:pointer;">
                  <input type="checkbox" data-import-item checked
                    data-title="é“¶æ²³ç³»æ¼«æ¸¸æŒ‡å—"
                    data-path="D:\\Books\\Misc\\é“¶æ²³ç³»æ¼«æ¸¸æŒ‡å—.md" />
                  é€‰æ‹©
                </label>
              </div>
            </div>
            <div class="item">
              <div class="item-main">
                <div class="item-title">é¡¹ç›®å¤ç›˜.log</div>
                <div class="item-sub">D:\Docs\Logs\é¡¹ç›®å¤ç›˜.log</div>
              </div>
              <div class="item-actions">
                <label class="pill" style="cursor:pointer;">
                  <input type="checkbox" data-import-item
                    data-title="é¡¹ç›®å¤ç›˜"
                    data-path="D:\\Docs\\Logs\\é¡¹ç›®å¤ç›˜.log" />
                  é€‰æ‹©
                </label>
              </div>
            </div>
            <div class="item">
              <div class="item-main">
                <div class="item-title">å°„é›•è‹±é›„ä¼ .txtï¼ˆé‡å¤å¯¼å…¥ç¤ºä¾‹ï¼‰</div>
                <div class="item-sub">D:\Books\Novels\å°„é›•è‹±é›„ä¼ .txt</div>
              </div>
              <div class="item-actions">
                <label class="pill" style="cursor:pointer;">
                  <input type="checkbox" data-import-item
                    data-title="å°„é›•è‹±é›„ä¼ "
                    data-path="D:\\Books\\Novels\\å°„é›•è‹±é›„ä¼ .txt" />
                  é€‰æ‹©
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mImport">å–æ¶ˆ</button>
          <button class="btn btn-primary" type="button" id="btnDoImport">å¯¼å…¥</button>
        </div>
      </div>
    </div>

    <!-- Modal: missing book repair -->
    <div class="modal-backdrop" id="mMissing" role="dialog" aria-modal="true" aria-label="ä¿®å¤ç¼ºå¤±æ–‡ä»¶">
      <div class="modal">
        <div class="modal-hd">
          <div>
            <div class="modal-title">æ–‡ä»¶ç¼ºå¤±</div>
            <div class="card-desc" id="missingPath" style="margin-top:6px;"></div>
          </div>
          <button class="btn btn-ghost" type="button" data-modal-close="mMissing" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          è¯¥ä¹¦æœ¬å¯¹åº”çš„æ–‡ä»¶å¯èƒ½è¢«ç§»åŠ¨æˆ–åˆ é™¤ã€‚ä½ å¯ä»¥é‡æ–°å®šä½åˆ°æ–°è·¯å¾„ï¼ˆä¿ç•™åŸ bookId ä¸é˜…è¯»è¿›åº¦ï¼‰ï¼Œæˆ–ä»ä¹¦åº“ç§»é™¤å¹¶æ¸…ç†è¿›åº¦ã€‚
        </div>
        <div class="modal-ft">
          <button class="btn btn-primary" type="button" id="btnRelink">é‡æ–°å®šä½æ–‡ä»¶</button>
          <button class="btn btn-danger" type="button" id="btnRemoveBook">ä»ä¹¦åº“ç§»é™¤</button>
          <button class="btn" type="button" data-modal-close="mMissing">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- Modal: item actions -->
    <div class="modal-backdrop" id="mActions" role="dialog" aria-modal="true" aria-label="æ›´å¤šæ“ä½œ">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">æ›´å¤šæ“ä½œ</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mActions" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <div class="muted" id="actionsTitle" style="margin-bottom:10px;"></div>
          <div class="list" aria-label="æ“ä½œåˆ—è¡¨">
            <div class="item">
              <div class="item-main">
                <div class="item-title">é‡å‘½åæ˜¾ç¤ºå</div>
                <div class="item-sub">ä¸æ”¹æ–‡ä»¶åï¼Œä»…ä¹¦æ¶å±•ç¤º</div>
              </div>
              <div class="item-actions">
                <button class="btn" type="button" id="btnRename">é‡å‘½å</button>
              </div>
            </div>
            <div class="item">
              <div class="item-main">
                <div class="item-title">åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤º</div>
                <div class="item-sub">ï¼ˆåŸå‹ä»…æç¤ºï¼Œä¸çœŸæ­£æ‰“å¼€ï¼‰</div>
              </div>
              <div class="item-actions">
                <button class="btn" type="button" id="btnReveal">æ˜¾ç¤º</button>
              </div>
            </div>
            <div class="item">
              <div class="item-main">
                <div class="item-title">ä»ä¹¦åº“ç§»é™¤</div>
                <div class="item-sub">åŒæ—¶æ¸…ç†è¯¥ä¹¦é˜…è¯»è¿›åº¦</div>
              </div>
              <div class="item-actions">
                <button class="btn btn-danger" type="button" id="btnRemoveFromActions">ç§»é™¤</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mActions">å…³é—­</button>
        </div>
      </div>
    </div>

    <!-- Modal: settings -->
    <div class="modal-backdrop" id="mSettings" role="dialog" aria-modal="true" aria-label="è®¾ç½®">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">è®¾ç½®ï¼ˆåŸå‹ï¼‰</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mSettings" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <label class="pill" style="cursor:pointer;">
            <input id="autoOpen2" type="checkbox" style="accent-color: var(--accent);" />
            å¯åŠ¨æ—¶è‡ªåŠ¨æ‰“å¼€ä¸Šæ¬¡ä¹¦åº“
          </label>
          <div class="sep"></div>
          <div class="row" style="align-items:flex-start;">
            <div style="flex:1; min-width:0;">
              <div class="card-title" style="font-size:13px;">å¤–è§‚è®¾ç½®ï¼ˆå…¨å±€ï¼‰</div>
              <div class="card-desc">é€æ˜åº¦ä¸ä¸»é¢˜è‰²ä¸ºå…¨å±€è®¾ç½®ï¼šåœ¨é˜…è¯»å™¨é¡¶éƒ¨â€œå¤–è§‚â€ä¸­ç»Ÿä¸€è°ƒæ•´ã€‚</div>
            </div>
            <button class="btn" type="button" id="btnOpenAppearanceFromShelf" title="è·³è½¬åˆ°é˜…è¯»å™¨å¤–è§‚è®¾ç½®">å»è®¾ç½®</button>
          </div>
          <div class="sep"></div>
          <div class="muted" style="font-size:12.5px; line-height:1.65;">
            v2.0 NFRï¼šæ»šåŠ¨ä¿å­˜å»ºè®® â‰¤ 1 æ¬¡/2 ç§’ï¼›å†™å…¥ JSON éœ€åŸå­æ€§ï¼ˆåŸå‹ä»…æç¤ºï¼Œä¸å®ç°æ–‡ä»¶å†™å…¥ï¼‰ã€‚
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mSettings">å®Œæˆ</button>
        </div>
      </div>
    </div>

    <script src="./fb-ui.js"></script>
    <script>
      FB.initBase();

      const p = FB.parseParams();
      const state = p.get("state") || "default";

      let activeLibId = p.get("libraryId") || localStorage.getItem("fb_v2_activeLibraryId") || FB.data.getLibraries().activeLibraryId;
      if(activeLibId) FB.data.setActiveLibrary(activeLibId);

      const activeLibName = FB.qs("#activeLibName");
      const bookRows = FB.qs("#bookRows");
      const search = FB.qs("#search");
      const continueWrap = FB.qs("#continueCardWrap");
      const libListModal = FB.qs("#libListModal");
      const autoOpen2 = FB.qs("#autoOpen2");
      const btnOpenAppearanceFromShelf = FB.qs("#btnOpenAppearanceFromShelf");

      let pendingBookId = null;
      let pendingBookTitle = null;

      function escapeHTML(s){
        return String(s).replace(/[&<>"']/g, (c)=>({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      function getActiveLibrary(){
        const { libraries, activeLibraryId } = FB.data.getLibraries();
        const id = activeLibId || activeLibraryId;
        return libraries.find(l=>l.id===id) || libraries[0] || null;
      }

      function renderTopBar(){
        const lib = getActiveLibrary();
        activeLibId = lib?.id || null;
        activeLibName.textContent = lib ? lib.name : "æœªé€‰æ‹©";
        const suffix = lib ? `å½“å‰ä¹¦åº“ï¼š${lib.name}` : "æœªé€‰æ‹©ä¹¦åº“";
        FB.qs("#barSubtitle").textContent = `v2.0 Â· ä¹¦æ¶ Â· ${suffix}`;
      }

      function renderLibModal(){
        const { libraries, activeLibraryId } = FB.data.getLibraries();
        libListModal.innerHTML = "";
        libraries.forEach(lib=>{
          const invalid = !!lib.invalidReason;
          const item = document.createElement("div");
          item.className = "item";
          item.innerHTML = `
            <div class="item-main">
              <div class="item-title">${escapeHTML(lib.name)}
                ${lib.id===activeLibraryId?` <span class="badge ok">å½“å‰</span>`:""}
                ${invalid?` <span class="badge bad">è·¯å¾„å¤±æ•ˆ</span>`:""}
              </div>
              <div class="item-sub">${escapeHTML(lib.path)}</div>
            </div>
            <div class="item-actions">
              <button class="btn ${invalid?"btn-danger":"btn-primary"}" type="button" data-switch-lib="${escapeHTML(lib.id)}">
                ${invalid?"å»å¤„ç†":"åˆ‡æ¢"}
              </button>
            </div>
          `;
          libListModal.appendChild(item);
        });
      }

      function renderContinueCard(){
        const lib = getActiveLibrary();
        if(!lib) return;
        const booksDoc = FB.data.getBooks(lib.id);
        const prog = FB.data.getProgress(lib.id);
        const lastId = prog.lastReadBookId;
        const book = booksDoc.books.find(b=>b.id===lastId);
        if(!book){
          continueWrap.innerHTML = `
            <div class="empty" style="padding:14px 12px;">
              <h2>æš‚æ— å¯ç»­è¯»ä¹¦æœ¬</h2>
              <p>æ‰“å¼€ä¸€æœ¬ä¹¦åä¼šè‡ªåŠ¨å‡ºç°åœ¨è¿™é‡Œã€‚</p>
            </div>`;
          return;
        }
        const ratio = (prog.progressByBookId?.[book.id]?.scrollRatio ?? 0);
        const pct = Math.round(ratio*100);
        continueWrap.innerHTML = `
          <div class="card" style="border-radius:14px; background: rgba(7,11,21,.34);">
            <div class="card-hd" style="padding:12px 12px 10px 12px;">
              <div style="min-width:0;">
                <div class="card-title" style="font-size:13.5px;">${escapeHTML(book.displayTitle)}</div>
                <div class="card-desc">è¿›åº¦ ${pct}% Â· ${escapeHTML(book.filePath)}</div>
              </div>
              <span class="badge ok">æœ€è¿‘</span>
            </div>
            <div class="card-bd" style="padding:0 12px 12px 12px;">
              <button class="btn btn-primary" type="button" id="btnContinue">ç»§ç»­</button>
            </div>
          </div>
        `;
        const btn = FB.qs("#btnContinue");
        btn?.addEventListener("click", ()=> openBook(book.id));
      }

      function renderBooks(){
        const lib = getActiveLibrary();
        if(!lib) return;
        const doc = FB.data.getBooks(lib.id);
        const q = (search.value || "").trim().toLowerCase();
        const filtered = doc.books.filter(b=>{
          const hay = `${b.displayTitle} ${b.filePath}`.toLowerCase();
          return !q || hay.includes(q);
        });

        bookRows.innerHTML = "";
        filtered.forEach(b=>{
          const missing = !!b.missing;
          const row = document.createElement("div");
          row.className = "t-row";
          row.setAttribute("role","row");
          row.innerHTML = `
            <div class="t-cell" role="cell">
              <div class="t-title">${escapeHTML(b.displayTitle)}</div>
              <div class="t-meta">${escapeHTML(b.filePath)}</div>
            </div>
            <div class="t-cell hide-xs" role="cell">
              <div class="t-meta">${FB.formatTime(b.fileStat?.mtimeMs)}</div>
            </div>
            <div class="t-cell" role="cell">
              ${missing?`<span class="badge bad">æ–‡ä»¶ç¼ºå¤±</span>`:`<span class="badge ok">å¯æ‰“å¼€</span>`}
            </div>
            <div class="t-cell t-actions" role="cell">
              <button class="btn ${missing?"btn-danger":"btn-primary"}" type="button" data-open="${escapeHTML(b.id)}">${missing?"ä¿®å¤â€¦":"æ‰“å¼€"}</button>
              <button class="btn btn-ghost" type="button" data-more="${escapeHTML(b.id)}" aria-label="æ›´å¤šæ“ä½œ">â‹¯</button>
            </div>
          `;
          bookRows.appendChild(row);
        });

        if(!doc.books.length){
          FB.setParam("state", "empty");
          FB.applyState();
        }
      }

      function openBook(bookId){
        const lib = getActiveLibrary();
        if(!lib) return;
        const doc = FB.data.getBooks(lib.id);
        const b = doc.books.find(x=>x.id===bookId);
        if(!b) return;
        if(b.missing){
          pendingBookId = b.id;
          pendingBookTitle = b.displayTitle;
          FB.qs("#missingPath").textContent = b.filePath;
          FB.openModal("mMissing");
          return;
        }
        // mark openedAt
        b.lastOpenedAt = Date.now();
        localStorage.setItem(`fb_v2_books_${lib.id}`, JSON.stringify(doc));
        location.href = `./reader.html?libraryId=${encodeURIComponent(lib.id)}&bookId=${encodeURIComponent(b.id)}`;
      }

      // wiring
      FB.qs("#btnLibSwitcher").addEventListener("click", ()=>{
        renderLibModal();
        FB.openModal("mLibs");
      });
      libListModal.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-switch-lib]");
        if(!btn) return;
        const id = btn.getAttribute("data-switch-lib");
        const { libraries } = FB.data.getLibraries();
        const lib = libraries.find(l=>l.id===id);
        if(lib?.invalidReason){
          FB.closeModal("mLibs");
          location.href = "./library-picker.html?state=default";
          return;
        }
        FB.data.setActiveLibrary(id);
        activeLibId = id;
        FB.closeModal("mLibs");
        FB.toast("å·²åˆ‡æ¢ä¹¦åº“", lib?.name || id);
        renderTopBar();
        renderContinueCard();
        renderBooks();
      });

      // import
      FB.qs("#btnImport").addEventListener("click", ()=> FB.openModal("mImport"));
      FB.qsa("[data-open-import]").forEach(b=> b.addEventListener("click", ()=> FB.openModal("mImport")));
      FB.qs("#btnDoImport").addEventListener("click", ()=>{
        const lib = getActiveLibrary();
        if(!lib) return;
        const checks = FB.qsa("[data-import-item]");
        const files = checks.filter(c=>c.checked).map(c=>({
          displayTitle: c.getAttribute("data-title"),
          filePath: c.getAttribute("data-path"),
          size: 400000,
          mtimeMs: Date.now() - 1000*60*60*24*Math.floor(Math.random()*30)
        }));
        const { added, dup } = FB.data.importBooks(lib.id, files);
        FB.closeModal("mImport");
        if(added.length) FB.toast("å¯¼å…¥æˆåŠŸ", `æ–°å¢ ${added.length} æœ¬`);
        if(dup.length) FB.toast("å·²å­˜åœ¨", `è·³è¿‡ ${dup.length} æœ¬ï¼ˆå»é‡ï¼‰`);
        FB.setParam("state", "default");
        FB.applyState();
        renderContinueCard();
        renderBooks();
      });

      // open/more actions
      bookRows.addEventListener("click", (e)=>{
        const openBtn = e.target.closest("[data-open]");
        const moreBtn = e.target.closest("[data-more]");
        if(openBtn){
          openBook(openBtn.getAttribute("data-open"));
        }
        if(moreBtn){
          const id = moreBtn.getAttribute("data-more");
          const lib = getActiveLibrary();
          const doc = FB.data.getBooks(lib.id);
          const b = doc.books.find(x=>x.id===id);
          if(!b) return;
          pendingBookId = b.id;
          pendingBookTitle = b.displayTitle;
          FB.qs("#actionsTitle").textContent = `${b.displayTitle} Â· ${b.filePath}`;
          FB.openModal("mActions");
        }
      });

      // missing repair flow
      FB.qs("#btnRelink").addEventListener("click", ()=>{
        const lib = getActiveLibrary();
        if(!lib || !pendingBookId) return;
        const newPath = `D:\\\\Books\\\\Recovered\\\\${pendingBookTitle || "book"}.txt`;
        FB.data.relinkBook(lib.id, pendingBookId, newPath);
        FB.closeModal("mMissing");
        FB.toast("å·²é‡æ–°å®šä½æ–‡ä»¶", "ä¿ç•™åŸè¿›åº¦");
        renderBooks();
      });
      FB.qs("#btnRemoveBook").addEventListener("click", ()=>{
        const lib = getActiveLibrary();
        if(!lib || !pendingBookId) return;
        FB.data.removeBook(lib.id, pendingBookId);
        FB.closeModal("mMissing");
        FB.toast("å·²ä»ä¹¦åº“ç§»é™¤", "åŒæ—¶æ¸…ç†è¿›åº¦");
        renderContinueCard();
        renderBooks();
      });

      // actions modal
      FB.qs("#btnReveal").addEventListener("click", ()=>{
        FB.toast("å·²å¤åˆ¶è·¯å¾„ï¼ˆæ¼”ç¤ºï¼‰", pendingBookTitle || "");
      });
      FB.qs("#btnRemoveFromActions").addEventListener("click", ()=>{
        const lib = getActiveLibrary();
        if(!lib || !pendingBookId) return;
        FB.data.removeBook(lib.id, pendingBookId);
        FB.closeModal("mActions");
        FB.toast("å·²ç§»é™¤ä¹¦æœ¬", "åŒæ—¶æ¸…ç†è¿›åº¦");
        renderContinueCard();
        renderBooks();
      });
      FB.qs("#btnRename").addEventListener("click", ()=>{
        const lib = getActiveLibrary();
        if(!lib || !pendingBookId) return;
        const name = prompt("è¾“å…¥æ–°çš„æ˜¾ç¤ºåï¼ˆä¸æ”¹æ–‡ä»¶åï¼‰", pendingBookTitle || "");
        if(!name) return;
        const doc = FB.data.getBooks(lib.id);
        const b = doc.books.find(x=>x.id===pendingBookId);
        if(!b) return;
        b.displayTitle = name;
        localStorage.setItem(`fb_v2_books_${lib.id}`, JSON.stringify(doc));
        FB.toast("å·²é‡å‘½åæ˜¾ç¤ºå", name);
        renderContinueCard();
        renderBooks();
      });

      // settings modal
      FB.qs("#btnSettings").addEventListener("click", ()=>{
        autoOpen2.checked = !!FB.data.getLibraries().settings.autoOpenLastLibrary;
        FB.openModal("mSettings");
      });
      autoOpen2.addEventListener("change", ()=>{
        FB.data.setAutoOpen(autoOpen2.checked);
        FB.toast("å·²æ›´æ–°è®¾ç½®", autoOpen2.checked ? "è‡ªåŠ¨æ‰“å¼€ä¸Šæ¬¡ä¹¦åº“ï¼šå¼€" : "è‡ªåŠ¨æ‰“å¼€ä¸Šæ¬¡ä¹¦åº“ï¼šå…³");
      });
      btnOpenAppearanceFromShelf?.addEventListener("click", ()=>{
        const debug = (FB.parseParams().get("debug") === "1");
        const lib = getActiveLibrary();
        const qsParts = [
          `state=empty`,
          `open=appearance`,
          lib?.id ? `libraryId=${encodeURIComponent(lib.id)}` : null,
          debug ? `debug=1` : null,
        ].filter(Boolean);
        location.href = `./reader.html?${qsParts.join("&")}`;
      });

      // search
      search.addEventListener("input", ()=> renderBooks());

      // error state recovery (demo)
      FB.qs("#btnResetBooks")?.addEventListener("click", ()=>{
        localStorage.removeItem("fb_v2_libraries");
        Object.keys(localStorage).filter(k=>k.startsWith("fb_v2_books_")||k.startsWith("fb_v2_progress_")).forEach(k=>localStorage.removeItem(k));
        location.href = "./bookshelf.html";
      });

      // initial render for non-loading views
      renderTopBar();
      if(state === "default"){
        renderContinueCard();
        renderBooks();
      }
      if(state === "empty"){
        renderContinueCard();
      }
    </script>
  </body>
</html>
