<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fishing Book Â· v2.0 Â· ä¹¦æ¶</title>
    <link rel="stylesheet" href="./fb-ui.css" />
  </head>
  <body>
    <div class="app">
      <div class="window" role="application" aria-label="Fishing Book v2.0 Â· ä¹¦æ¶">
        <div class="window-bar">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div class="title">Fishing Book</div>
            <div class="subtitle" id="barSubtitle">v2.0 Â· ä¹¦æ¶</div>
          </div>
          <div class="bar-actions" aria-label="ä¹¦æ¶å·¥å…·æ ">
            <button class="btn" type="button" id="btnLibSwitcher" aria-haspopup="dialog">
              <span aria-hidden="true">ğŸ—‚</span>
              <span id="activeLibName">å½“å‰ä¹¦åº“</span>
              <span class="faint" aria-hidden="true">â–¼</span>
            </button>
            <button class="btn btn-primary" type="button" id="btnImport">
              <span aria-hidden="true">ï¼‹</span> å¯¼å…¥ä¹¦æœ¬
            </button>
            <button class="btn btn-ghost" type="button" id="btnSettings" aria-haspopup="dialog">è®¾ç½®</button>
          </div>
        </div>

        <div class="content">
          <div class="grid cols-2">
            <section class="card">
              <div class="card-hd">
                <div>
                  <div class="card-title">ç»§ç»­é˜…è¯»</div>
                  <div class="card-desc">æ‰“å¼€ä¸€æœ¬ä¹¦åä¼šè‡ªåŠ¨å‡ºç°åœ¨è¿™é‡Œã€‚</div>
                </div>
              </div>
              <div class="card-bd" id="continueCardWrap"></div>
            </section>

            <section class="card">
              <div class="card-hd">
                <div>
                  <div class="card-title">ä¹¦æœ¬åˆ—è¡¨</div>
                  <div class="card-desc">æ”¯æŒï¼šæ‰“å¼€ã€é‡å‘½åæ˜¾ç¤ºåã€ç§»é™¤ã€æ–‡ä»¶ç¼ºå¤±ä¿®å¤ã€‚</div>
                </div>
                <div class="row">
                  <input class="input" id="search" placeholder="æœç´¢ä¹¦å/è·¯å¾„â€¦" autocomplete="off" />
                </div>
              </div>

              <div class="card-bd">
                <div class="state is-active" data-state="loading">
                  <div class="skeleton" style="height:14px; width:56%;"></div>
                  <div style="height:10px;"></div>
                  <div class="skeleton" style="height:14px; width:92%;"></div>
                  <div style="height:10px;"></div>
                  <div class="skeleton" style="height:14px; width:78%;"></div>
                </div>

                <div class="state" data-state="default">
                  <div class="t-head" role="rowgroup">
                    <div class="t-row t-row-head" role="row">
                      <div class="t-cell" role="columnheader">ä¹¦æœ¬</div>
                      <div class="t-cell hide-xs" role="columnheader">æ›´æ–°æ—¶é—´</div>
                      <div class="t-cell" role="columnheader">çŠ¶æ€</div>
                      <div class="t-cell t-actions" role="columnheader">æ“ä½œ</div>
                    </div>
                  </div>
                  <div class="t-body" id="bookRows" role="rowgroup" aria-label="ä¹¦æœ¬åˆ—è¡¨"></div>
                </div>

                <div class="state" data-state="empty">
                  <div class="empty">
                    <div class="illus" aria-hidden="true"></div>
                    <h2>ä¹¦æ¶é‡Œè¿˜æ²¡æœ‰ä¹¦æœ¬</h2>
                    <p>ç‚¹å‡»â€œå¯¼å…¥ä¹¦æœ¬â€ä»æœ¬åœ°é€‰æ‹© <span class="kbd">.txt</span> / <span class="kbd">.log</span> / <span class="kbd">.md</span>ã€‚</p>
                    <div class="cta">
                      <button class="btn btn-primary" type="button" data-open-import>
                        <span aria-hidden="true">ï¼‹</span> å¯¼å…¥ä¹¦æœ¬
                      </button>
                    </div>
                  </div>
                </div>

                <div class="state" data-state="error">
                  <div class="empty">
                    <div class="illus" aria-hidden="true"></div>
                    <h2>æ— æ³•åŠ è½½ä¹¦æœ¬æ¸…å•</h2>
                    <p>è¯·å°è¯•åˆ‡æ¢ä¹¦åº“æˆ–æ£€æŸ¥æ–‡ä»¶æƒé™ã€‚</p>
                    <div class="cta">
                      <a class="btn btn-primary" href="./library-picker.html" title="è¿”å›ä¹¦åº“é€‰æ‹©">è¿”å›ä¹¦åº“é€‰æ‹©</a>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="mLibs" role="dialog" aria-modal="true" aria-label="åˆ‡æ¢ä¹¦åº“">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">åˆ‡æ¢ä¹¦åº“</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mLibs" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <div class="list" id="libListModal" aria-label="ä¹¦åº“åˆ—è¡¨"></div>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mLibs">å…³é—­</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="mImport" role="dialog" aria-modal="true" aria-label="å¯¼å…¥ä¹¦æœ¬">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">å¯¼å…¥ä¹¦æœ¬</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mImport" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <div class="muted">å°†æ‰“å¼€ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨ï¼Œå¯å¤šé€‰ <span class="kbd">.txt</span> / <span class="kbd">.log</span> / <span class="kbd">.md</span>ï¼ˆå¼•ç”¨åŸè·¯å¾„ï¼Œä¸å¤åˆ¶æ–‡ä»¶ï¼‰ã€‚</div>
          <div class="sep"></div>
          <div class="row" style="justify-content:flex-start; gap:10px;">
            <button class="btn btn-primary" type="button" id="btnPickFiles">é€‰æ‹©æ–‡ä»¶â€¦</button>
          </div>
          <div style="height:12px;"></div>
          <div class="card-title" style="font-size:13px;">å¯¼å…¥ç»“æœ</div>
          <div class="card-desc" id="importResultMeta">å°šæœªå¯¼å…¥ã€‚</div>
          <div style="height:10px;"></div>
          <div class="list" id="importResultList" aria-label="å¯¼å…¥ç»“æœåˆ—è¡¨"></div>
          <button class="btn" type="button" id="btnDoFallbackImport" style="display:none;">fallback</button>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mImport">å®Œæˆ</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="mMissing" role="dialog" aria-modal="true" aria-label="æ–‡ä»¶ç¼ºå¤±å¤„ç†">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">æ–‡ä»¶ç¼ºå¤±</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mMissing" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <div class="banner bad">
            <div class="msg">
              æ‰¾ä¸åˆ°è¯¥æ–‡ä»¶
              <div class="sub" id="missingPath"></div>
            </div>
          </div>
          <div class="sep"></div>
          <div class="row" style="justify-content:flex-start; gap:10px;">
            <button class="btn btn-primary" type="button" id="btnRelink">é‡æ–°å®šä½æ–‡ä»¶â€¦</button>
            <button class="btn btn-danger" type="button" id="btnRemoveBook">ä»ä¹¦åº“ç§»é™¤</button>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mMissing">å…³é—­</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="mActions" role="dialog" aria-modal="true" aria-label="ä¹¦æœ¬æ“ä½œ">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">æ›´å¤šæ“ä½œ</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mActions" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <div class="muted" id="actionsTitle"></div>
          <div class="sep"></div>
          <div class="row" style="justify-content:flex-start; gap:10px; flex-wrap:wrap;">
            <button class="btn" type="button" id="btnRename">é‡å‘½åæ˜¾ç¤ºåâ€¦</button>
            <button class="btn" type="button" id="btnReveal">å¤åˆ¶è·¯å¾„</button>
            <button class="btn btn-danger" type="button" id="btnRemoveFromActions">ç§»é™¤</button>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mActions">å…³é—­</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="mSettings" role="dialog" aria-modal="true" aria-label="è®¾ç½®">
      <div class="modal">
        <div class="modal-hd">
          <div class="modal-title">è®¾ç½®</div>
          <button class="btn btn-ghost" type="button" data-modal-close="mSettings" aria-label="å…³é—­">âœ•</button>
        </div>
        <div class="modal-bd">
          <label class="check">
            <input type="checkbox" id="autoOpen2" />
            å¯åŠ¨æ—¶è‡ªåŠ¨æ‰“å¼€ä¸Šæ¬¡ä¹¦åº“
          </label>
          <div class="sep"></div>
          <div class="row" style="justify-content:flex-start; gap:10px;">
            <button class="btn" type="button" id="btnOpenAppearanceFromShelf">é˜…è¯»å™¨å¤–è§‚è®¾ç½®â€¦</button>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" type="button" data-modal-close="mSettings">å®Œæˆ</button>
        </div>
      </div>
    </div>

    <script src="./fb-ui.js"></script>
    <script>
      (async ()=>{
        await FB.initBase();

        const p = FB.parseParams();
        const activeLibName = FB.qs("#activeLibName");
        const bookRows = FB.qs("#bookRows");
        const search = FB.qs("#search");
        const continueWrap = FB.qs("#continueCardWrap");
        const libListModal = FB.qs("#libListModal");
        const autoOpen2 = FB.qs("#autoOpen2");
        const btnOpenAppearanceFromShelf = FB.qs("#btnOpenAppearanceFromShelf");
        const btnPickFiles = FB.qs("#btnPickFiles");
        const btnDoFallbackImport = FB.qs("#btnDoFallbackImport");
        const importResultMeta = FB.qs("#importResultMeta");
        const importResultList = FB.qs("#importResultList");

        let currentLibId = null;
        let currentBooks = [];
        let pendingBookId = null;
        let pendingBookTitle = null;
        let importInFlight = false;

        function setState(state){
          FB.qsa("[data-state]").forEach(el=>{
            el.classList.toggle("is-active", el.getAttribute("data-state") === state);
          });
        }

        function escapeHTML(s){
          return String(s).replace(/[&<>"']/g, (c)=>({
            "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
          }[c]));
        }

        function formatTime(ts){
          try{
            const d = new Date(ts);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            return `${yyyy}-${mm}-${dd}`;
          }catch(_e){ return "â€”"; }
        }

        async function loadLibraries(){
          const res = await window.electronAPI.libraryList();
          return res && res.success ? res.data : null;
        }

        async function ensureCurrentLibrary(){
          const data = await loadLibraries();
          if(!data) return null;
          const fromUrl = p.get("libraryId");
          const id = fromUrl || data.activeLibraryId || (data.libraries[0] ? data.libraries[0].id : null);
          if(!id) return null;
          const lib = (data.libraries||[]).find(l=>l.id===id) || null;
          if(!lib || lib.invalidReason){
            location.href = "./library-picker.html";
            return null;
          }
          await window.electronAPI.librarySetActive(id);
          currentLibId = id;
          activeLibName.textContent = lib.name || "å½“å‰ä¹¦åº“";
          FB.qs("#barSubtitle").textContent = `v2.0 Â· ä¹¦æ¶ Â· å½“å‰ä¹¦åº“ï¼š${lib.name || ""}`;
          return { data, lib };
        }

        async function loadBooks(){
          if(!currentLibId) return null;
          const res = await window.electronAPI.bookList(currentLibId);
          if(!res || !res.success) return null;
          currentBooks = res.books || [];
          return currentBooks;
        }

        function renderBooks(){
          const q = (search.value || "").trim().toLowerCase();
          const filtered = (currentBooks||[]).filter(b=>{
            const hay = `${b.displayTitle||""} ${b.filePath||""}`.toLowerCase();
            return !q || hay.includes(q);
          });

          bookRows.innerHTML = "";
          filtered.forEach(b=>{
            const missing = !!b.missing;
            const row = document.createElement("div");
            row.className = "t-row";
            row.setAttribute("role","row");
            row.innerHTML = `
              <div class="t-cell" role="cell">
                <div class="t-title">${escapeHTML(b.displayTitle || "æœªå‘½å")}</div>
                <div class="t-meta">${escapeHTML(b.filePath || "")}</div>
              </div>
              <div class="t-cell hide-xs" role="cell">
                <div class="t-meta">${formatTime(b.fileStat?.mtimeMs)}</div>
              </div>
              <div class="t-cell" role="cell">
                ${missing?`<span class="badge bad">æ–‡ä»¶ç¼ºå¤±</span>`:`<span class="badge ok">å¯æ‰“å¼€</span>`}
              </div>
              <div class="t-cell t-actions" role="cell">
                <button class="btn ${missing?"btn-danger":"btn-primary"}" type="button" data-open="${escapeHTML(b.id)}">${missing?"ä¿®å¤â€¦":"æ‰“å¼€"}</button>
                <button class="btn btn-ghost" type="button" data-more="${escapeHTML(b.id)}" aria-label="æ›´å¤šæ“ä½œ">â‹¯</button>
              </div>
            `;
            bookRows.appendChild(row);
          });

          setState(currentBooks.length ? "default" : "empty");
        }

        async function renderContinueCard(){
          if(!currentLibId) return;
          const pr = await window.electronAPI.progressDoc(currentLibId);
          const doc = pr && pr.success ? pr.data : null;
          const lastId = doc?.lastReadBookId || null;
          const book = lastId ? (currentBooks||[]).find(b=>b.id===lastId) : null;
          if(!book){
            continueWrap.innerHTML = `
              <div class="empty" style="padding:14px 12px;">
                <h2>æš‚æ— å¯ç»­è¯»ä¹¦æœ¬</h2>
                <p>æ‰“å¼€ä¸€æœ¬ä¹¦åä¼šè‡ªåŠ¨å‡ºç°åœ¨è¿™é‡Œã€‚</p>
              </div>`;
            return;
          }
          const ratio = (doc?.progressByBookId?.[book.id]?.scrollRatio ?? 0);
          const pct = Math.round(ratio*100);
          continueWrap.innerHTML = `
            <div class="card" style="border-radius:14px; background: rgba(7,11,21,.34);">
              <div class="card-hd" style="padding:12px 12px 10px 12px;">
                <div style="min-width:0;">
                  <div class="card-title" style="font-size:13.5px;">${escapeHTML(book.displayTitle || "æœªå‘½å")}</div>
                  <div class="card-desc">è¿›åº¦ ${pct}% Â· ${escapeHTML(book.filePath || "")}</div>
                </div>
                <span class="badge ok">æœ€è¿‘</span>
              </div>
              <div class="card-bd" style="padding:0 12px 12px 12px;">
                <button class="btn btn-primary" type="button" id="btnContinue">ç»§ç»­</button>
              </div>
            </div>
          `;
          FB.qs("#btnContinue")?.addEventListener("click", ()=> openBook(book.id));
        }

        function openBook(bookId){
          const b = (currentBooks||[]).find(x=>x.id===bookId);
          if(!b) return;
          if(b.missing){
            pendingBookId = b.id;
            pendingBookTitle = b.displayTitle || "";
            FB.qs("#missingPath").textContent = b.filePath || "";
            FB.openModal("mMissing");
            return;
          }
          location.href = `./reader.html?libraryId=${encodeURIComponent(currentLibId)}&bookId=${encodeURIComponent(b.id)}`;
        }

        function renderImportResult(res){
          const added = res?.added || [];
          const dup = res?.dup || [];
          const failed = res?.failed || [];
          importResultMeta.textContent = `æ–°å¢ ${added.length} Â· è·³è¿‡é‡å¤ ${dup.length} Â· å¤±è´¥ ${failed.length}`;
          importResultList.innerHTML = "";

          function addItem(kind, title, sub){
            const item = document.createElement("div");
            item.className = "item";
            item.innerHTML = `
              <div class="item-main">
                <div class="item-title">${escapeHTML(title)}</div>
                <div class="item-sub">${escapeHTML(sub || "")}</div>
              </div>
              <div class="item-actions">
                <span class="badge ${kind === "ok" ? "ok" : kind === "dup" ? "warn" : "bad"}">${kind === "ok" ? "æ–°å¢" : kind === "dup" ? "é‡å¤" : "å¤±è´¥"}</span>
              </div>
            `;
            importResultList.appendChild(item);
          }

          added.forEach(x=> addItem("ok", x.displayTitle || "æœªå‘½å", x.filePath || ""));
          dup.forEach(x=> addItem("dup", x.displayTitle || "é‡å¤æ¡ç›®", x.filePath || ""));
          failed.forEach(x=> addItem("bad", x.displayTitle || "å¯¼å…¥å¤±è´¥", (x.filePath||"") + (x.reason ? ` Â· ${x.reason}` : "")));
        }

        async function startImport(){
          if(!currentLibId) return;
          if(importInFlight) return;
          importInFlight = true;
          btnPickFiles.disabled = true;
          const oldText = btnPickFiles.textContent;
          btnPickFiles.textContent = "ç­‰å¾…é€‰æ‹©â€¦";
          importResultMeta.textContent = "æ­£åœ¨æ‰“å¼€ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨â€¦";
          importResultList.innerHTML = "";

          const res = await window.electronAPI.bookImportFiles(currentLibId);
          btnPickFiles.disabled = false;
          btnPickFiles.textContent = oldText;
          importInFlight = false;
          if(!res || !res.success){
            importResultMeta.textContent = res?.canceled ? "å·²å–æ¶ˆé€‰æ‹©ã€‚" : "å¯¼å…¥å¤±è´¥ã€‚";
            return;
          }
          renderImportResult(res);
          await loadBooks();
          renderBooks();
          await renderContinueCard();
        }

        FB.qs("#btnImport").addEventListener("click", ()=>{
          FB.openModal("mImport");
          setTimeout(()=> startImport(), 60);
        });
        FB.qsa("[data-open-import]").forEach(b=> b.addEventListener("click", ()=>{
          FB.openModal("mImport");
          setTimeout(()=> startImport(), 60);
        }));
        btnPickFiles.addEventListener("click", startImport);
        btnDoFallbackImport.addEventListener("click", startImport);

        FB.qs("#btnLibSwitcher").addEventListener("click", async ()=>{
          const data = await loadLibraries();
          if(!data) return;
          libListModal.innerHTML = "";
          (data.libraries||[]).forEach(lib=>{
            const invalid = !!lib.invalidReason;
            const item = document.createElement("div");
            item.className = "item";
            item.innerHTML = `
              <div class="item-main">
                <div class="item-title">${escapeHTML(lib.name || "")}
                  ${lib.id===data.activeLibraryId?` <span class="badge ok">å½“å‰</span>`:""}
                  ${invalid?` <span class="badge bad">è·¯å¾„å¤±æ•ˆ</span>`:""}
                </div>
                <div class="item-sub">${escapeHTML(lib.path || "")}</div>
              </div>
              <div class="item-actions">
                <button class="btn ${invalid?"btn-danger":"btn-primary"}" type="button" data-switch-lib="${escapeHTML(lib.id)}">
                  ${invalid?"å»å¤„ç†":"åˆ‡æ¢"}
                </button>
              </div>
            `;
            libListModal.appendChild(item);
          });
          FB.openModal("mLibs");
        });

        libListModal.addEventListener("click", async (e)=>{
          const btn = e.target.closest("[data-switch-lib]");
          if(!btn) return;
          const id = btn.getAttribute("data-switch-lib");
          const data = await loadLibraries();
          const lib = (data?.libraries||[]).find(l=>l.id===id);
          if(!lib || lib.invalidReason){
            FB.closeModal("mLibs");
            location.href = "./library-picker.html";
            return;
          }
          await window.electronAPI.librarySetActive(id);
          FB.closeModal("mLibs");
          currentLibId = id;
          activeLibName.textContent = lib.name || "å½“å‰ä¹¦åº“";
          FB.qs("#barSubtitle").textContent = `v2.0 Â· ä¹¦æ¶ Â· å½“å‰ä¹¦åº“ï¼š${lib.name || ""}`;
          await loadBooks();
          renderBooks();
          await renderContinueCard();
        });

        bookRows.addEventListener("click", (e)=>{
          const openBtn = e.target.closest("[data-open]");
          const moreBtn = e.target.closest("[data-more]");
          if(openBtn) openBook(openBtn.getAttribute("data-open"));
          if(moreBtn){
            const id = moreBtn.getAttribute("data-more");
            const b = (currentBooks||[]).find(x=>x.id===id);
            if(!b) return;
            pendingBookId = b.id;
            pendingBookTitle = b.displayTitle || "";
            FB.qs("#actionsTitle").textContent = `${b.displayTitle || "æœªå‘½å"} Â· ${b.filePath || ""}`;
            FB.openModal("mActions");
          }
        });

        FB.qs("#btnRelink").addEventListener("click", async ()=>{
          if(!currentLibId || !pendingBookId) return;
          await window.electronAPI.bookRelinkFile(currentLibId, pendingBookId);
          FB.closeModal("mMissing");
          await loadBooks();
          renderBooks();
        });
        FB.qs("#btnRemoveBook").addEventListener("click", async ()=>{
          if(!currentLibId || !pendingBookId) return;
          await window.electronAPI.bookRemove(currentLibId, pendingBookId);
          FB.closeModal("mMissing");
          await loadBooks();
          renderBooks();
          await renderContinueCard();
        });

        FB.qs("#btnRemoveFromActions").addEventListener("click", async ()=>{
          if(!currentLibId || !pendingBookId) return;
          await window.electronAPI.bookRemove(currentLibId, pendingBookId);
          FB.closeModal("mActions");
          await loadBooks();
          renderBooks();
          await renderContinueCard();
        });
        FB.qs("#btnRename").addEventListener("click", async ()=>{
          if(!currentLibId || !pendingBookId) return;
          const name = prompt("è¾“å…¥æ–°çš„æ˜¾ç¤ºåï¼ˆä¸æ”¹æ–‡ä»¶åï¼‰", pendingBookTitle || "");
          if(!name) return;
          await window.electronAPI.bookRename(currentLibId, pendingBookId, name);
          await loadBooks();
          renderBooks();
          await renderContinueCard();
        });

        FB.qs("#btnReveal").addEventListener("click", ()=>{
          try{
            const b = (currentBooks||[]).find(x=>x.id===pendingBookId);
            if(b?.filePath) navigator.clipboard?.writeText(b.filePath);
          }catch(_e){}
        });

        FB.qs("#btnSettings").addEventListener("click", async ()=>{
          const s = await window.electronAPI.settingsGet();
          autoOpen2.checked = !!s?.data?.autoOpenLastLibrary;
          FB.openModal("mSettings");
        });
        autoOpen2.addEventListener("change", async ()=>{
          await window.electronAPI.settingsUpdate({ autoOpenLastLibrary: autoOpen2.checked });
        });
        btnOpenAppearanceFromShelf.addEventListener("click", ()=>{
          const qsParts = [
            `open=appearance`,
            currentLibId ? `libraryId=${encodeURIComponent(currentLibId)}` : null,
          ].filter(Boolean);
          location.href = `./reader.html?${qsParts.join("&")}`;
        });

        setState("loading");
        const ok = await ensureCurrentLibrary();
        if(!ok){
          setState("error");
          return;
        }
        await loadBooks();
        renderBooks();
        await renderContinueCard();
      })();
    </script>
  </body>
</html>
